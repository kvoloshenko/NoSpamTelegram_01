import logging
from dotenv import load_dotenv
import os
from langchain_ollama import ChatOllama
from langchain_core.messages import HumanMessage

load_dotenv()

LOCAL_LLM = os.getenv('LOCAL_LLM')
print(f'LOCAL_LLM ={LOCAL_LLM }')

logger = logging.getLogger(__name__)

async def check_spam(topic: str) -> bool:
    prompt = f"""
    ะขั โ ะฐะฝัะธัะฟะฐะผ-ัะธะปััั Telegram. ะัะฒะตัะฐะน ัััะพะณะพ SPAM ะธะปะธ NOT_SPAM.  
    ะะตัะบะฐ SPAM ััะฐะฒะธััั ะฟัะธ ะผะฐะปะตะนัะธั ะฟัะธะทะฝะฐะบะฐั ยซะฑัััััั ะดะตะฝะตะณยป, ะตัะปะธ ัะพะพะฑัะตะฝะธะต ะฝะต ะฟะพะดะฟะฐะดะฐะตั ะฟะพะด ะธัะบะปััะตะฝะธั.

    ==================================================
    ๐ฅ ะะะะขะะะะ ะกะะะะ  
    (*ะดะพััะฐัะพัะฝะพ โฅ 1 Core-ััะธะณะณะตัะฐ **ะธ** โฅ 1 Secondary-ััะธะณะณะตัะฐ*)
    --------------------------------------------------
    **Core-ััะธะณะณะตัั (AโB, ะพะฑัะทะฐัะตะปัะฝะฐ ะบะฐะบ ะผะธะฝะธะผัะผ ะพะดะฝะฐ ะบะฐัะตะณะพัะธั):**

    A. ะะะะะะะซะ ะะะะฉะะะะฏ  
      โข ะงััะบะธะต ััะผะผั / ะฟัะพัะตะฝัั: ยซ$150ยป, ยซ80% ะฟัะธะฑัะปะธยป, ยซ50/50ยป  
      โข ะะฑะตัะฐะฝะธั ะดะพัะพะดะฐ ะดะฐะถะต ะฑะตะท ัะธัั: ยซะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝัะน ะดะพัะพะดยป, ยซะฟะฐััะธะฒะฝะพยป, ยซะฑะตะท ะฒะปะพะถะตะฝะธะนยป  
      โข ะกัะตะผั: ยซะผะพะดะตะปั X/Yยป, ยซะฟะฐััะฝััะบะฐยป, ยซัะพะฟัะพะฒะพะถะดะตะฝะธะตยป, ยซะฑะตะท ัะธัะบะฐยป

    B. ะะะะะซะ ะ ะะะะขะะะขะฃ / ะะะะกะขะะะฎ  
      โข ยซะะฐะฟะธัะธยป, ยซะฟะธัะธยป, ยซะฟะธัะธัะตยป, ยซะฒ ะปะธัะบัยป, ยซะฒ ะะกยป, ยซ+ ะฒ ัะฐัยป  
      โข ะััะผัะต ัััะปะบะธ ะฝะฐ ะบะพะฝัะฐะบั / ะฝะธะบ / ะฑะพัะฐ

    **Secondary-ััะธะณะณะตัั (CโD, ะฝะตะพะฑัะพะดะธะผ ัะพัั ะฑั ะพะดะธะฝ):**

    C. ะะะะะขะะะะะะะะ  
      โข ยซะขะพะปัะบะพ N ัะตะปะพะฒะตะบยป, ยซ2 ะผะตััะฐยป, ยซะฟะพัะปะตะดะฝะธะต ะผะตััะฐยป  
      โข ะกัะพัะฝะพััั: ยซะดะพ ะบะพะฝัะฐ ะดะฝัยป, ยซะฑัััััะน ััะฐััยป, ยซัะตะณะพะดะฝัยป

    D. ะะะะะะฃะะฏะฆะะ / ะะกะะะะ-ะะะะะะฌะะะกะขะฌ  
      โข ยซะะธัะตะณะพ ะฝะต ัะตััะตัะตยป, ยซะฑะตะท ะพะฑัะทะฐัะตะปัััะฒยป  
      โข ยซะัั ะพัะธัะธะฐะปัะฝะพยป, ยซะปะตะณะฐะปัะฝะพยป, ยซััะฐะฑะธะปัะฝะพยป, ยซะฟัะพะทัะฐัะฝัะน ะดะพะณะพะฒะพัยป

    ==================================================
    ๐ฉ ะะกะะะฎะงะะะะฏ โ NOT_SPAM  
    (ะปัะฑะพะน ะฟะพะดะฟัะฝะบั ะฟะตัะตะบััะฒะฐะตั ััะธะณะณะตัั ะฒััะต)
    --------------------------------------------------
    โ๏ธ **ะขะตัะฝะธัะตัะบะธะน ะบะพะฝัะตะฝั**  
      โข ะะฐะทะฒะฐะฝะธั/ะฟะฐัะฐะผะตััั ะะ: ยซLlama-3ยป, ยซ17B-16E-Instructยป, ยซRAGยป, ยซัะผะฑะตะดะดะธะฝะณะธยป, ยซvector storeยป, ยซpromptยป, ยซัะตะผะฟะตัะฐัััะฐยป, ยซัะฐะฝะบะธยป, ยซะฑะฐะทะฐ ะดะฐะฝะฝััยป, ยซะบะพะดยป, ยซะดะพะบัะผะตะฝัะฐัะธัยป  
      โข ะกะตัะฒะธัั/ะฟะปะฐััะพัะผั: ยซsalebotยป, ยซTelegram APIยป, ยซะบะพะฝััััะบัะพั ะฑะพัะพะฒยป  
      โข ะขะตั-ะฟัะพัะตััั: ยซะฟะพะธัะบ ะฟะพ ะฒะตะบัะพัะฝะพะน ะฑะฐะทะตยป, ยซะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ัะพะพะฑัะตะฝะธะนยป, ยซัะตััะธัะพะฒะฐะฝะธะต ะผะพะดะตะปะธยป

    โ๏ธ **ะะตัะฐ-ะบะพะฝัะตะบัั ะพ ะฑะพัะต**  
      โข ะคัะฐะทั: ยซะฑะพั ัะดะฐะปะธะปยป, ยซะปะพะถะฝะพะต ััะฐะฑะฐััะฒะฐะฝะธะตยป, ยซัะตััะธัะพะฒะฐะฝะธะต ะฑะพัะฐยป, ยซะปะพะบะฐะปัะฝะฐั LLMยป, ยซะฐะฝัะธัะฟะฐะผ-ัะธะปัััยป  
      โข ะฃะฟะพะผะธะฝะฐะฝะธั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั: ยซะฟะตัะตัะพัะผัะปะธัะพะฒะฐัั ะฟะพััยป, ยซะฒะพัััะฐะฝะพะฒะธัั ัะพะพะฑัะตะฝะธะตยป  
      โข **Telegram-ัััะปะบะธ** ัะฐะทัะตัะตะฝั, ะตัะปะธ ััะดะพะผ ะตััั โฅ1 ัะตั-ัะตัะผะธะฝ: (ยซLLMยป, ยซะผะพะดะตะปัยป, ยซะฐะฝัะธัะฟะฐะผยป, ยซัะตััะธัะพะฒะฐะฝะธะตยป, ยซะฑะพัยป)

    โ๏ธ **Safelist ะดะปั ะผะตัะฐ-ัะพะพะฑัะตะฝะธะน**  
      โข ะกะพะดะตัะถะธั ยซัะตััะธัะพะฒะฐะฝะธะตยป **ะธ** ยซะฑะพัยป **ะธ** ะพะดะฝะพ ะธะท:  
        (ยซLLMยป, ยซะฐะฝัะธัะฟะฐะผยป, ยซะฐะฝัะธ-ัะฟะฐะผยป, ยซะฒะพัััะฐะฝะพะฒะธััยป, ยซะฟะตัะตัะพัะผัะปะธัะพะฒะฐััยป, ยซะปะพะบะฐะปัะฝะฐั ะผะพะดะตะปัยป) โ NOT_SPAM

    โ๏ธ **ะะพัะพัะบะธะต ะฒะพะฟัะพัั/ะพัะทัะฒั**  
      โข ะะพะฟัะพัั โค15 ัะปะพะฒ ั ยซ?ยป ะฑะตะท ะดะตะฝะตะณ (ะดะฐะถะต ะฟัะธ ะฝะฐะปะธัะธะธ ััะธะณะณะตัะพะฒ):  
        ยซะะพะถะฝะพ ะฟะพััะฝะธัั?ยป, ยซะฐ ะฑะพั ัะดะฐะปัะตั ะฒัะต ัะพะพะฑัะตะฝะธั?ยป, ยซะฟะพะดัะบะฐะถะธัะต ะบะฐะบ ะผะพะถะฝะพ ะพััะปะตะดะธัั?ยป  
      โข ะัะทัะฒั โค20 ัะปะพะฒ ะฑะตะท ะดะตะฝะตะณ/ะฟัะธะทัะฒะพะฒ:  
        ยซะะฝัะตัะตัะฝะฐั ะผะพะดะตะปั. ะัะถะฝะพ ะฑะพะปััะต ัะตััะพะฒยป, ยซะฟะพะด RAG ะธะผะตะตัะต ะฒะฒะธะดั vector store?ยป  
      โข ะขะตั-ะฒะพะฟัะพัั ั ะบะปััะตะฒัะผะธ ัะปะพะฒะฐะผะธ:  
        ยซะผะพะดะตะปัยป, ยซะฑะพัยป, ยซัะธะปัััยป, ยซัะฟะฐะผยป, ยซะบะพะดยป, ยซpromptยป, ยซRAGยป

    ==================================================
    ๐ก ะะะะขะะงะะกะะะ ะะะะะะะะะะฏ (v2.0)
    --------------------------------------------------
    โ **ะฃะถะตััะพัะตะฝะธั ยซะดะตะฝะตะถะฝัะน + ะฟัะธะทัะฒยป**  
      โข ะัะฑะฐั ะดะตะฝะตะถะฝะฐั ะตะดะธะฝะธัะฐ ($, ยซะดะพะปะปะฐัยป, ยซะฑะฐะบัะพะฒยป) + ะฟัะธะทัะฒ (ยซะฟะธัะธยป, ยซ+ยป, ยซะปัยป) โ SPAM  
      โข ะะตะฝะตะถะฝะฐั ะตะดะธะฝะธัะฐ + ะฟะตัะธะพะด (ยซะฒ ะดะตะฝัยป, ยซะฒ ะฝะตะดะตะปัยป) โ SPAM  
      โข ยซะดะพัะพะดยป/ยซะทะฐัะฐะฑะพัะพะบยป + ะฟัะธะทัะฒ ะบ ะบะพะฝัะฐะบัั โ SPAM

    ๐ **ะะต ะธะทะผะตะฝัะตััั:** ะฒัะต ะธัะบะปััะตะฝะธั ะดะปั ัะตั-ะบะพะฝัะตะฝัะฐ ะธ ะผะตัะฐ-ะพะฑััะถะดะตะฝะธะน.

    ==================================================
    โ๏ธ ะะะจะะฎะฉะะ ะะะะะะะ
    --------------------------------------------------
    1. SPAM, ะตัะปะธ ะฒัะฟะพะปะฝัะตััั **ะปัะฑะพะต** ะธะท:  
       โข (A + B) + (C ะธะปะธ D)  
       โข ะกััะปะบะฐ + ะดะตะฝะตะถะฝัะต ัะตัะผะธะฝั  
       โข ะัะธะทัะฒ + ะปะธะผะธั ะฒัะตะผะตะฝะธ  
       โข ะัะฐะฒะธะปะฐ ัะถะตััะพัะตะฝะธั v2.0

    2. NOT_SPAM, ะตัะปะธ ะฒัะฟะพะปะฝัะตััั **ัะพัั ะฑั ะพะดะฝะพ**:  
       โข ะกะพะพัะฒะตัััะฒัะตั ะธัะบะปััะตะฝะธัะผ (ัะตั-ะบะพะฝัะตะฝั, ะผะตัะฐ-ะบะพะฝัะตะบัั, ะบะพัะพัะบะธะต ะฒะพะฟัะพัั)  
       โข ะะฑััะถะดะตะฝะธะต ัะฐะฑะพัั ะะ/ะฑะพัะพะฒ ะฑะตะท ะดะตะฝะตะถะฝัั ััะธะณะณะตัะพะฒ  
       โข ะกะพะพะฑัะตะฝะธั ั ัะตั-ัะตัะผะธะฝะฐะผะธ, ะดะฐะถะต ะฟัะธ ะฝะฐะปะธัะธะธ ะดััะณะธั ััะธะณะณะตัะพะฒ

    3. **ะัะพะฑัะต ัะปััะฐะธ:**  
       โข ะะฑัััะบะฐัะธั (ยซะฒ_ะะกยป, ยซะป/ัยป) โ ะฟัะธะทัะฒ  
       โข ะะพะถะฝัะต ััะฐะฑะฐััะฒะฐะฝะธั โ NOT_SPAM  
       โข ยซะผะพะดะตะปัยป + ยซัะตััยป โ ะฐะฒัะพะผะฐัะธัะตัะบะธ NOT_SPAM

    ==================================================
    ะกะพะพะฑัะตะฝะธะต: {{question}}
    ะัะฒะตั:
    """


    try:
        # ะะฝะธัะธะฐะปะธะทะฐัะธั ะปะพะบะฐะปัะฝะพะน ัะทัะบะพะฒะพะน ะผะพะดะตะปะธ ั ะฟะฐัะฐะผะตััะฐะผะธ
        # local_llm = "llama3.2:3b-instruct-fp16"
        # local_llm = "deepseek-r1:14b"
        llm = ChatOllama(model=LOCAL_LLM, temperature=0)

        # ะคะพัะผะธัะพะฒะฐะฝะธะต ะทะฐะฟัะพัะฐ ะดะปั LLM
        # print(f'text={topic}')
        prompt_formatted = prompt.format(question=topic)
        # ะัะฟัะฐะฒะบะฐ ะทะฐะฟัะพัะฐ (ััะพัะผะธัะพะฒะฐะฝะฝะพะณะพ ะฟัะพะผะฟัะฐ) ะฒ ะผะพะดะตะปั ะธ ะฟะพะปััะตะฝะธะต ะพัะฒะตัะฐ
        generation = llm.invoke([HumanMessage(content=prompt_formatted)])
        model_response = generation.content
        print(f'model_response={model_response}')
        print(type(model_response))


        return model_response == "SPAM"
    except Exception as e:
        logger.error(f"ะัะธะฑะบะฐ ะฟัะธ ะฟัะพะฒะตัะบะต ะฝะฐ ัะฟะฐะผ: {e}")
        return False